#include <Wire.h>
#include <IRremote.h>
#include <INA219.h>
#include <LiquidCrystal_I2C.h> // LCD ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€

// ================= 1. í•€ ë²ˆí˜¸ ì„¤ì • (5ë²ˆ, 6ë²ˆ) =================
const int PIN_MOSFET = 2;   // ì „ì²´ ì „ì›
const int PIN_PWM = 5;      // ì„ í’ê¸° ì†ë„
const int PIN_DIR = 6;      // ì„ í’ê¸° ë°©í–¥
const int PIN_IR = 7;       // ë¦¬ëª¨ì»¨

// LCD ê°ì²´ (ì£¼ì†Œ 0x27 ê°€ì •)
LiquidCrystal_I2C lcd(0x27, 16, 2);

// ================= 2. ë¦¬ëª¨ì»¨ ë²„íŠ¼ =================
#define CMD_OK      0x1C
#define CMD_STOP    0x19
#define CMD_SPEED_1 0x45
#define CMD_SPEED_2 0x46
#define CMD_SPEED_3 0x47

// ================= 3. ì†ë„ ì„¤ì • =================
const int SPEED_OFF = 0;
const int SPEED_1   = 100;
const int SPEED_2   = 170;
const int SPEED_3   = 255;

// ================= 4. ë³€ìˆ˜ ì„¤ì • =================
INA219 ina(0x40);              
bool isReady = false;          
unsigned long lastTime = 0;    
int currentLevel = 0;           // í˜„ì¬ ë‹¨ê³„ (0~3)

// ================= 5. í•¨ìˆ˜ ì •ì˜ =================

// [ëª¨í„° ì œì–´ í•¨ìˆ˜] Active Low ì ìš© (255 - speed)
void controlFan(int speed) {
  digitalWrite(PIN_DIR, HIGH);      
  analogWrite(PIN_PWM, 255 - speed);
}

// [LCD ìƒíƒœ í‘œì‹œ í•¨ìˆ˜]
void updateLCDStatus(int level, float current_mA) {
  // LCD 1í–‰: Level X í‘œì‹œ
  lcd.setCursor(0, 0);
  lcd.print("Level ");
  lcd.print(level);
  lcd.print("        "); // ê³µë°±ìœ¼ë¡œ ë’¤ì˜ ì”ìƒ ì œê±°

  // LCD 2í–‰: Current X mA í‘œì‹œ (ì†Œìˆ˜ì  1ìë¦¬ê¹Œì§€)
  lcd.setCursor(0, 1);
  lcd.print("Current:");
  lcd.print(current_mA, 1); // ì†Œìˆ˜ì  ì²«ì§¸ ìë¦¬ê¹Œì§€ í‘œì‹œ
  lcd.print("mA  "); // ê³µë°±ìœ¼ë¡œ ë’¤ì˜ ì”ìƒ ì œê±°
}

void setup() {
  Serial.begin(9600);
  Wire.begin();

  pinMode(PIN_MOSFET, OUTPUT);
  pinMode(PIN_PWM, OUTPUT);
  pinMode(PIN_DIR, OUTPUT);

  // [ì´ˆê¸° ìƒíƒœ ì„¤ì • - Active Low]
  digitalWrite(PIN_MOSFET, HIGH);
  digitalWrite(PIN_DIR, HIGH);    
  analogWrite(PIN_PWM, 255);      

  IrReceiver.begin(PIN_IR, ENABLE_LED_FEEDBACK);

  // LCD ì´ˆê¸°í™”
  lcd.init();
  lcd.backlight();
  lcd.clear();
  lcd.print("System Initializing...");

  if (!ina.begin()) {
    lcd.clear();
    lcd.print("INA219 Error!");
    Serial.println("Error: INA219 not connected!");
    while(1);
  }
  // INA219 ì„¤ì •
  ina.setMaxCurrentShunt(2.5, 0.1);

  lcd.clear();
  lcd.print("Press [OK] to Start");
  updateLCDStatus(currentLevel, 0.0); // ì´ˆê¸° ìƒíƒœ 0ë‹¨, 0.0mA í‘œì‹œ
 
  // ë°ì´í„° í—¤ë” ì¶œë ¥
  Serial.println("Time(ms),Level,BusVoltage(V),Current(mA)");
}

void loop() {
  // ==========================================================
  // [ê¸°ëŠ¥ 1] ì „ë¥˜ ë°ì´í„° ìˆ˜ì§‘ (1ì´ˆ ê°„ê²©, ì‹¤ì‹œê°„)
  // ==========================================================
  if (millis() - lastTime >= 1000) {
    lastTime = millis();
   
    float bus_V = ina.getBusVoltage();    // ì „ì••
    float current_mA = ina.getCurrent_mA(); // ì „ë¥˜
   
    // ğŸ“¢ ì‹œë¦¬ì–¼ ëª¨ë‹ˆí„° ì¶œë ¥
    Serial.print("Time: ");
    Serial.print(millis());
    Serial.print(" ms | Level: ");
    Serial.print(currentLevel);
    Serial.print(" | Volt: ");
    Serial.print(bus_V);
    Serial.print(" V | Current: ");
    Serial.print(current_mA);
    Serial.println(" mA");

    // ğŸ“¢ LCD ì‹¤ì‹œê°„ ê°±ì‹ 
    updateLCDStatus(currentLevel, current_mA);
  }

  // ==========================================================
  // [ê¸°ëŠ¥ 2] ë¦¬ëª¨ì»¨ ì œì–´
  // ==========================================================
  if (IrReceiver.decode()) {
    uint16_t command = IrReceiver.decodedIRData.command;
   
    // ë…¸ì´ì¦ˆ í•„í„°
    if (command == 0 || (IrReceiver.decodedIRData.flags & IRDATA_FLAGS_IS_REPEAT)) {
      IrReceiver.resume();
      return;
    }

    // [ì ê¸ˆ í•´ì œ]
    if (command == CMD_OK) {
      isReady = true;
      lcd.clear();
      lcd.print("UNLOCKED!       ");
      Serial.println(">>> [UNLOCKED] Ready!");
    }
   
    // [ì†ë„ ë³€ê²½]
    else if (isReady == true) {
      int prevLevel = currentLevel; // ì´ì „ ë ˆë²¨ ì €ì¥
     
      if (command == CMD_STOP) {
        controlFan(SPEED_OFF);
        currentLevel = 0;
        Serial.println(">>> Speed 0 (STOP)");
        isReady = false; // ì •ì§€ í›„ì—ëŠ” ë‹¤ì‹œ ì ê¸ˆ
      }
      else if (command == CMD_SPEED_1) {
        controlFan(SPEED_1);
        currentLevel = 1;
        Serial.println(">>> Speed 1");
      }
      else if (command == CMD_SPEED_2) {
        controlFan(SPEED_2);
        currentLevel = 2;
        Serial.println(">>> Speed 2");
      }
      else if (command == CMD_SPEED_3) {
        controlFan(SPEED_3);
        currentLevel = 3;
        Serial.println(">>> Speed 3");
      }

      // ë ˆë²¨ì´ ë³€ê²½ë˜ì—ˆë‹¤ë©´ LCDì— ë³€ê²½ ë©”ì‹œì§€ ì¶œë ¥ (ì ì‹œ)
      if (prevLevel != currentLevel) {
        lcd.clear();
        lcd.print("Level Changed to:");
        lcd.setCursor(0, 1);
        lcd.print(currentLevel);
      }
    }
    IrReceiver.resume();
  }
}
